# Artwork Matcher API Documentation

## System Overview

The Artwork Matcher is a microservices-based system for identifying museum artworks from visitor photos. It uses a two-stage pipeline: fast embedding-based retrieval followed by geometric verification.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ARTWORK MATCHER SYSTEM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                              â”‚   Client    â”‚                                     â”‚
â”‚                              â”‚  (Browser,  â”‚                                     â”‚
â”‚                              â”‚  Mobile App,â”‚                                     â”‚
â”‚                              â”‚    curl)    â”‚                                     â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â”‚ HTTP/JSON                                  â”‚
â”‚                                     â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         GATEWAY SERVICE (:8000)                           â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â”‚   â€¢ Public API endpoint           â€¢ CORS handling                         â”‚   â”‚
â”‚  â”‚   â€¢ Pipeline orchestration        â€¢ Error aggregation                     â”‚   â”‚
â”‚  â”‚   â€¢ Request validation            â€¢ Response formatting                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚            â”‚                        â”‚                        â”‚                  â”‚
â”‚            â–¼                        â–¼                        â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   EMBEDDINGS     â”‚    â”‚     SEARCH       â”‚    â”‚    GEOMETRIC     â”‚          â”‚
â”‚  â”‚   SERVICE        â”‚    â”‚     SERVICE      â”‚    â”‚    SERVICE       â”‚          â”‚
â”‚  â”‚   (:8001)        â”‚    â”‚     (:8002)      â”‚    â”‚    (:8003)       â”‚          â”‚
â”‚  â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚          â”‚
â”‚  â”‚  â€¢ DINOv2 model  â”‚    â”‚  â€¢ FAISS index   â”‚    â”‚  â€¢ ORB features  â”‚          â”‚
â”‚  â”‚  â€¢ 768-dim       â”‚    â”‚  â€¢ Metadata      â”‚    â”‚  â€¢ RANSAC        â”‚          â”‚
â”‚  â”‚    embeddings    â”‚    â”‚    storage       â”‚    â”‚    verification  â”‚          â”‚
â”‚  â”‚  â€¢ ~50-100ms     â”‚    â”‚  â€¢ <1ms search   â”‚    â”‚  â€¢ ~50ms/pair    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                          â”‚   DATA STORAGE   â”‚                                   â”‚
â”‚                          â”‚                  â”‚                                   â”‚
â”‚                          â”‚  /data/objects/  â”‚  Reference images                 â”‚
â”‚                          â”‚  /data/index/    â”‚  FAISS index + metadata           â”‚
â”‚                          â”‚  /data/features/ â”‚  Pre-computed ORB features        â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Service Summary

| Service | Port | Purpose | Key Technology |
|---------|------|---------|----------------|
| **Gateway** | 8000 | Public API, orchestration | FastAPI, httpx |
| **Embeddings** | 8001 | Image â†’ vector | DINOv2, PyTorch |
| **Search** | 8002 | Vector similarity search | FAISS |
| **Geometric** | 8003 | Spatial verification | OpenCV, ORB, RANSAC |
| **Storage** | 8004 | Binary object storage | Filesystem |

## Detailed API Specifications

| Document | Description |
|----------|-------------|
| [Uniform API Structure](uniform_api_structure.md) | Common endpoints, error handling, and conventions across all services |
| [Gateway Service API](gateway_service_api_spec.md) | Public API orchestration and pipeline coordination |
| [Embeddings Service API](embeddings_service_api_spec.md) | DINOv2 embedding extraction |
| [Search Service API](search_service_api_spec.md) | FAISS vector similarity search |
| [Geometric Service API](geometric_service_api_spec.md) | ORB + RANSAC geometric verification |

---

## API Endpoints Overview

### Gateway Service (Port 8000) â€” Public API

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/health` | Health check with backend status |
| `GET` | `/info` | Service configuration |
| `POST` | `/identify` | **Main endpoint** â€” identify artwork in photo |
| `GET` | `/objects` | List all museum objects |
| `GET` | `/objects/{id}` | Get object details |
| `GET` | `/objects/{id}/image` | Get reference image |

### Embeddings Service (Port 8001) â€” Internal

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/health` | Health check |
| `GET` | `/info` | Model configuration |
| `POST` | `/embed` | Extract embedding from image |

### Search Service (Port 8002) â€” Internal

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/health` | Health check |
| `GET` | `/info` | Index statistics |
| `POST` | `/search` | Find similar vectors |
| `POST` | `/add` | Add embedding to index |
| `POST` | `/index/save` | Persist index to disk |
| `POST` | `/index/load` | Load index from disk |
| `DELETE` | `/index` | Clear index |

### Geometric Service (Port 8003) â€” Internal

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/health` | Health check |
| `GET` | `/info` | Algorithm configuration |
| `POST` | `/extract` | Extract ORB features |
| `POST` | `/match` | Compare two images |
| `POST` | `/match/batch` | Compare query against multiple references |

### Storage Service (Port 8004) â€” Internal

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/health` | Health check |
| `GET` | `/info` | Storage configuration and object count |
| `PUT` | `/objects/{id}` | Store binary object |
| `GET` | `/objects/{id}` | Retrieve binary object |
| `DELETE` | `/objects/{id}` | Delete a single object |
| `DELETE` | `/objects` | Delete all stored objects |

---

## Sequence Diagrams

### 1. Artwork Identification (Main Flow)

This is the primary use case: a visitor takes a photo and wants to know what artwork it shows.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Gateway â”‚     â”‚ Embeddings â”‚     â”‚ Search â”‚     â”‚ Geometric â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚ POST /identifyâ”‚                â”‚                â”‚                â”‚
    â”‚ {image: b64}  â”‚                â”‚                â”‚                â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ POST /embed    â”‚                â”‚                â”‚
    â”‚               â”‚ {image: b64}   â”‚                â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚ Extract        â”‚                â”‚
    â”‚               â”‚                â”‚ DINOv2         â”‚                â”‚
    â”‚               â”‚                â”‚ embedding      â”‚                â”‚
    â”‚               â”‚                â”‚ (~50-100ms)    â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚   {embedding}  â”‚                â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ POST /search                    â”‚                â”‚
    â”‚               â”‚ {embedding, k:5, threshold:0.7} â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚ FAISS search   â”‚
    â”‚               â”‚                â”‚                â”‚ (<1ms)         â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚   {results: [{object_id, score}...]}             â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ POST /match/batch                                â”‚
    â”‚               â”‚ {query_image, references: [...]}                 â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚ Extract ORB
    â”‚               â”‚                â”‚                â”‚                â”‚ Match features
    â”‚               â”‚                â”‚                â”‚                â”‚ RANSAC verify
    â”‚               â”‚                â”‚                â”‚                â”‚ (~100-200ms)
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚   {best_match: {object_id, confidence, inliers}} â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ Combine scores â”‚                â”‚                â”‚
    â”‚               â”‚ Format responseâ”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚ {success: trueâ”‚                â”‚                â”‚                â”‚
    â”‚  match: {     â”‚                â”‚                â”‚                â”‚
    â”‚    object_id, â”‚                â”‚                â”‚                â”‚
    â”‚    name,      â”‚                â”‚                â”‚                â”‚
    â”‚    confidence,â”‚                â”‚                â”‚                â”‚
    â”‚    ...        â”‚                â”‚                â”‚                â”‚
    â”‚  },           â”‚                â”‚                â”‚                â”‚
    â”‚  timing: {...}â”‚                â”‚                â”‚                â”‚
    â”‚ }             â”‚                â”‚                â”‚                â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
```

**Timing Breakdown:**
- Embedding extraction: 50-100ms
- Vector search: <1ms
- Geometric verification: 100-200ms (for 5 candidates)
- **Total: 150-300ms**

---

### 2. Index Building (Setup Flow)

Before the system can identify artworks, we need to build the search index from reference images.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚build_indexâ”‚     â”‚ Embeddings â”‚     â”‚ Search â”‚
â”‚   .py     â”‚     â”‚  Service   â”‚     â”‚ Serviceâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚                 â”‚                â”‚
      â”‚                 â”‚                â”‚
      â”‚ DELETE /index   â”‚                â”‚
      â”‚ (clear existing)â”‚                â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                 â”‚                â”‚
      â”‚     {previous_count: 0}          â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                 â”‚                â”‚
      â”‚                 â”‚                â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         FOR EACH object image           â”‚
      â”‚                 â”‚                â”‚      â”‚
      â”‚ POST /embed     â”‚                â”‚      â”‚
      â”‚ {image: b64,    â”‚                â”‚      â”‚
      â”‚  image_id}      â”‚                â”‚      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚      â”‚
      â”‚                 â”‚                â”‚      â”‚
      â”‚                 â”‚ DINOv2         â”‚      â”‚
      â”‚                 â”‚ inference      â”‚      â”‚
      â”‚                 â”‚                â”‚      â”‚
      â”‚ {embedding,     â”‚                â”‚      â”‚
      â”‚  dimension}     â”‚                â”‚      â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚      â”‚
      â”‚                 â”‚                â”‚      â”‚
      â”‚ POST /add       â”‚                â”‚      â”‚
      â”‚ {object_id,     â”‚                â”‚      â”‚
      â”‚  embedding,     â”‚                â”‚      â”‚
      â”‚  metadata}      â”‚                â”‚      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚      â”‚
      â”‚                 â”‚                â”‚      â”‚
      â”‚ {index_position,â”‚                â”‚      â”‚
      â”‚  index_count}   â”‚                â”‚      â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
      â”‚                 â”‚                â”‚      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                 â”‚                â”‚
      â”‚                 â”‚                â”‚
      â”‚ POST /index/saveâ”‚                â”‚
      â”‚ {}              â”‚                â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                 â”‚                â”‚
      â”‚                 â”‚                â”‚ Write FAISS
      â”‚                 â”‚                â”‚ index to disk
      â”‚                 â”‚                â”‚
      â”‚ {index_path,    â”‚                â”‚
      â”‚  count: 20}     â”‚                â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                 â”‚                â”‚
      â”‚                 â”‚                â”‚
     â–ˆâ–ˆâ–ˆ Index built with 20 objects â–ˆâ–ˆâ–ˆ
      â”‚                 â”‚                â”‚
```

**For 20 objects:**
- 20 Ã— embedding extraction (~100ms each) = ~2 seconds
- 20 Ã— index add (<1ms each) = negligible
- 1 Ã— index save (<10ms) = negligible
- **Total: ~2-3 seconds**

---

### 3. No Match Found (Edge Case)

When the visitor photo doesn't match any known artwork.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Gateway â”‚     â”‚ Embeddings â”‚     â”‚ Search â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚               â”‚                â”‚                â”‚
    â”‚ POST /identifyâ”‚                â”‚                â”‚
    â”‚ {image: b64}  â”‚                â”‚                â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚ POST /embed    â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚   {embedding}  â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚ POST /search   â”‚                â”‚
    â”‚               â”‚ {threshold:0.7}â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚ All scores
    â”‚               â”‚                â”‚                â”‚ below 0.7
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚   {results: []}â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚ No candidates  â”‚                â”‚
    â”‚               â”‚ Skip geometric â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚ {success: trueâ”‚                â”‚                â”‚
    â”‚  match: null, â”‚                â”‚                â”‚
    â”‚  message: "No matching artwork found"          â”‚
    â”‚  debug: {highest_similarity: 0.43}}            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
```

**Note:** This is a successful response (200 OK) â€” the system worked correctly, it just didn't find a match.

---

### 4. Graceful Degradation (Geometric Service Down)

When geometric verification fails, the system falls back to embedding-only results.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Gateway â”‚     â”‚ Embeddings â”‚     â”‚ Search â”‚     â”‚ Geometric â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚ POST /identifyâ”‚                â”‚                â”‚                â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ POST /embed    â”‚                â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚
    â”‚               â”‚   {embedding}  â”‚                â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ POST /search   â”‚                â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚               â”‚   {results: [{score: 0.92}...]}â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ POST /match/batch               â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚               â”‚                â”‚                â”‚           â”‚ SERVICE â”‚
    â”‚               â”‚                â”‚                â”‚           â”‚  DOWN   â”‚
    â”‚               â”‚â—€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ Connection refused
    â”‚               â”‚                â”‚                â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚                â”‚                â”‚
    â”‚               â”‚ Log warning    â”‚                â”‚
    â”‚               â”‚ Use embedding  â”‚                â”‚
    â”‚               â”‚ results only   â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
    â”‚ {success: trueâ”‚                â”‚                â”‚
    â”‚  match: {     â”‚                â”‚                â”‚
    â”‚    object_id, â”‚                â”‚                â”‚
    â”‚    confidence: 0.78,  â—€â”€â”€â”€ Reduced (no verification)
    â”‚    verification_method: "embedding_only"       â”‚
    â”‚  }}           â”‚                â”‚                â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚
```

**Key Point:** The client still gets a result, just with lower confidence and a note that geometric verification wasn't performed.

---

### 5. Health Check (Deep)

Checking the health of the entire system.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Gateway â”‚     â”‚ Embeddings â”‚     â”‚ Search â”‚     â”‚ Geometric â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚GET /health    â”‚                â”‚                â”‚                â”‚
    â”‚?check_backendsâ”‚                â”‚                â”‚                â”‚
    â”‚=true          â”‚                â”‚                â”‚                â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€ GET /health (parallel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚ Aggregate      â”‚                â”‚                â”‚
    â”‚               â”‚ results        â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
    â”‚ {status:      â”‚                â”‚                â”‚                â”‚
    â”‚   "healthy",  â”‚                â”‚                â”‚                â”‚
    â”‚  backends: {  â”‚                â”‚                â”‚                â”‚
    â”‚   embeddings: â”‚                â”‚                â”‚                â”‚
    â”‚    "healthy", â”‚                â”‚                â”‚                â”‚
    â”‚   search:     â”‚                â”‚                â”‚                â”‚
    â”‚    "healthy", â”‚                â”‚                â”‚                â”‚
    â”‚   geometric:  â”‚                â”‚                â”‚                â”‚
    â”‚    "healthy"  â”‚                â”‚                â”‚                â”‚
    â”‚  }}           â”‚                â”‚                â”‚                â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
    â”‚               â”‚                â”‚                â”‚                â”‚
```

---

## Data Flow Diagrams

### Embedding Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EMBEDDING EXTRACTION                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Input   â”‚    â”‚  Decode  â”‚    â”‚ Preprocessâ”‚    â”‚   DINOv2     â”‚  â”‚
â”‚   â”‚  Image   â”‚â”€â”€â”€â–¶â”‚  Base64  â”‚â”€â”€â”€â–¶â”‚  Resize   â”‚â”€â”€â”€â–¶â”‚   Model      â”‚  â”‚
â”‚   â”‚ (Base64) â”‚    â”‚  to RGB  â”‚    â”‚  518Ã—518  â”‚    â”‚  Inference   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚          â”‚
â”‚                                                          â–¼          â”‚
â”‚                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                                   â”‚  CLS Token   â”‚  â”‚
â”‚                                                   â”‚  Embedding   â”‚  â”‚
â”‚                                                   â”‚  (768-dim)   â”‚  â”‚
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚          â”‚
â”‚                                                          â–¼          â”‚
â”‚                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                                   â”‚ L2 Normalize â”‚  â”‚
â”‚                                                   â”‚  (unit vec)  â”‚  â”‚
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚          â”‚
â”‚                                                          â–¼          â”‚
â”‚                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                                   â”‚   Output     â”‚  â”‚
â”‚                                                   â”‚  [f32 Ã— 768] â”‚  â”‚
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Search Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VECTOR SEARCH                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  Query   â”‚                    â”‚      FAISS Index           â”‚    â”‚
â”‚   â”‚Embedding â”‚                    â”‚   (IndexFlatIP)            â”‚    â”‚
â”‚   â”‚[768-dim] â”‚                    â”‚                            â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚        â”‚                          â”‚  â”‚obj_1â”‚ â”‚obj_2â”‚ â”‚ ... â”‚  â”‚    â”‚
â”‚        â”‚      Inner Product       â”‚  â”‚ 768 â”‚ â”‚ 768 â”‚ â”‚ 768 â”‚  â”‚    â”‚
â”‚        â”‚         Search           â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         20 vectors         â”‚    â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                â”‚                    â”‚
â”‚                                                â–¼                    â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                   â”‚     Top-K Results          â”‚    â”‚
â”‚                                   â”‚                            â”‚    â”‚
â”‚                                   â”‚  #1: obj_007  score: 0.92  â”‚    â”‚
â”‚                                   â”‚  #2: obj_012  score: 0.88  â”‚    â”‚
â”‚                                   â”‚  #3: obj_003  score: 0.85  â”‚    â”‚
â”‚                                   â”‚  #4: obj_019  score: 0.71  â”‚    â”‚
â”‚                                   â”‚  #5: obj_008  score: 0.65  â”‚    â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                â”‚                    â”‚
â”‚                                                â–¼                    â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                   â”‚   Threshold Filter (0.7)   â”‚    â”‚
â”‚                                   â”‚                            â”‚    â”‚
â”‚                                   â”‚  âœ“ obj_007  0.92           â”‚    â”‚
â”‚                                   â”‚  âœ“ obj_012  0.88           â”‚    â”‚
â”‚                                   â”‚  âœ“ obj_003  0.85           â”‚    â”‚
â”‚                                   â”‚  âœ“ obj_019  0.71           â”‚    â”‚
â”‚                                   â”‚  âœ— obj_008  0.65 (filtered)â”‚    â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Geometric Verification Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GEOMETRIC VERIFICATION                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Query Image  â”‚                           â”‚ Reference   â”‚          â”‚
â”‚  â”‚(visitor     â”‚                           â”‚ Image       â”‚          â”‚
â”‚  â”‚ photo)      â”‚                           â”‚ (from DB)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                         â”‚                 â”‚
â”‚         â–¼                                         â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ORB Feature  â”‚                           â”‚ORB Feature  â”‚          â”‚
â”‚  â”‚Extraction   â”‚                           â”‚Extraction   â”‚          â”‚
â”‚  â”‚             â”‚                           â”‚(or cached)  â”‚          â”‚
â”‚  â”‚â€¢ 1000 keyptsâ”‚                           â”‚â€¢ 1000 keyptsâ”‚          â”‚
â”‚  â”‚â€¢ 32-byte    â”‚                           â”‚â€¢ 32-byte    â”‚          â”‚
â”‚  â”‚  descriptorsâ”‚                           â”‚  descriptorsâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                         â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                          â”‚                                          â”‚
â”‚                          â–¼                                          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚               â”‚   BFMatcher         â”‚                               â”‚
â”‚               â”‚   (Hamming dist)    â”‚                               â”‚
â”‚               â”‚                     â”‚                               â”‚
â”‚               â”‚   knnMatch(k=2)     â”‚                               â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                          â”‚                                          â”‚
â”‚                          â–¼                                          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚               â”‚  Lowe's Ratio Test  â”‚                               â”‚
â”‚               â”‚  (threshold: 0.75)  â”‚                               â”‚
â”‚               â”‚                     â”‚                               â”‚
â”‚               â”‚  156 â†’ 124 matches  â”‚                               â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                          â”‚                                          â”‚
â”‚                          â–¼                                          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚               â”‚      RANSAC         â”‚                               â”‚
â”‚               â”‚  Homography Est.    â”‚                               â”‚
â”‚               â”‚                     â”‚                               â”‚
â”‚               â”‚  â€¢ reproj_thresh: 5 â”‚                               â”‚
â”‚               â”‚  â€¢ max_iters: 2000  â”‚                               â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                          â”‚                                          â”‚
â”‚                          â–¼                                          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚               â”‚      Result         â”‚                               â”‚
â”‚               â”‚                     â”‚                               â”‚
â”‚               â”‚  Inliers: 67        â”‚                               â”‚
â”‚               â”‚  Inlier ratio: 0.54 â”‚                               â”‚
â”‚               â”‚  Is match: âœ“        â”‚                               â”‚
â”‚               â”‚  Confidence: 0.85   â”‚                               â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete Identification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMPLETE IDENTIFICATION FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚    â”‚  Visitor   â”‚                                                            â”‚
â”‚    â”‚   Photo    â”‚                                                            â”‚
â”‚    â”‚            â”‚                                                            â”‚
â”‚    â”‚  ğŸ“± click! â”‚                                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚    â•‘                     STAGE 1: RETRIEVAL                            â•‘    â”‚
â”‚    â•‘                        (Fast, Global)                             â•‘    â”‚
â”‚    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•‘   Photo â”€â”€â–¶ DINOv2 â”€â”€â–¶ [768-dim vector] â”€â”€â–¶ FAISS â”€â”€â–¶ Top-5     â•‘    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•‘   Time: ~50-100ms                   Candidates by similarity      â•‘    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â”‚ Candidates: [0.92, 0.88, 0.85, 0.71]                             â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚    â•‘                    STAGE 2: VERIFICATION                          â•‘    â”‚
â”‚    â•‘                      (Precise, Local)                             â•‘    â”‚
â”‚    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•‘   For each candidate:                                             â•‘    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•‘   Photo â”€â”€â”¬â”€â”€â–¶ ORB â”€â”€â–¶ Match â”€â”€â–¶ RANSAC â”€â”€â–¶ Inliers?             â•‘    â”‚
â”‚    â•‘           â”‚     features                                          â•‘    â”‚
â”‚    â•‘   Ref   â”€â”€â”˜                                                       â•‘    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•‘   Time: ~100-200ms                Geometric consistency check     â•‘    â”‚
â”‚    â•‘                                                                   â•‘    â”‚
â”‚    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â”‚ Verified: obj_007 (67 inliers, confidence: 0.89)                 â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚                          RESULT                                     â”‚   â”‚
â”‚    â”‚                                                                     â”‚   â”‚
â”‚    â”‚   âœ“ Match Found                                                     â”‚   â”‚
â”‚    â”‚                                                                     â”‚   â”‚
â”‚    â”‚   Object:     Water Lilies                                          â”‚   â”‚
â”‚    â”‚   Artist:     Claude Monet                                          â”‚   â”‚
â”‚    â”‚   Year:       1906                                                  â”‚   â”‚
â”‚    â”‚   Confidence: 89%                                                   â”‚   â”‚
â”‚    â”‚                                                                     â”‚   â”‚
â”‚    â”‚   Total Time: 208ms                                                 â”‚   â”‚
â”‚    â”‚                                                                     â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request/Response Examples

### Identify Artwork

**Request:**
```bash
curl -X POST http://localhost:8000/identify \
  -H "Content-Type: application/json" \
  -d '{
    "image": "/9j/4AAQSkZJRg...",
    "options": {
      "geometric_verification": true,
      "include_alternatives": true
    }
  }'
```

**Response (Match Found):**
```json
{
  "success": true,
  "match": {
    "object_id": "object_007",
    "name": "Water Lilies",
    "artist": "Claude Monet",
    "year": "1906",
    "confidence": 0.89,
    "similarity_score": 0.92,
    "geometric_score": 0.85,
    "verification_method": "geometric"
  },
  "alternatives": [
    {
      "object_id": "object_012",
      "name": "Bridge over a Pond of Water Lilies",
      "confidence": 0.72
    }
  ],
  "timing": {
    "embedding_ms": 47.2,
    "search_ms": 1.3,
    "geometric_ms": 156.8,
    "total_ms": 208.4
  }
}
```

**Response (No Match):**
```json
{
  "success": true,
  "match": null,
  "message": "No matching artwork found with sufficient confidence",
  "timing": {
    "embedding_ms": 45.1,
    "search_ms": 1.2,
    "geometric_ms": 0,
    "total_ms": 49.8
  },
  "debug": {
    "highest_similarity": 0.43,
    "threshold": 0.7
  }
}
```

---

## Error Responses

| Scenario | HTTP Status | Error Code | Example |
|----------|-------------|------------|---------|
| Invalid image data | 400 | `invalid_image` | Corrupted Base64 |
| Backend unavailable | 502 | `backend_unavailable` | Service not running |
| Backend error | 502 | `backend_error` | FAISS index not loaded |
| Backend timeout | 504 | `backend_timeout` | Model inference too slow |
| Object not found | 404 | `not_found` | Unknown object_id |

**Example Error Response:**
```json
{
  "error": "backend_unavailable",
  "message": "Embeddings service is not responding",
  "details": {
    "backend": "embeddings",
    "url": "http://localhost:8001",
    "last_error": "Connection refused"
  }
}
```

---

## Configuration Reference

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GATEWAY__BACKENDS__EMBEDDINGS__URL` | `http://localhost:8001` | Embeddings service URL |
| `GATEWAY__BACKENDS__SEARCH__URL` | `http://localhost:8002` | Search service URL |
| `GATEWAY__BACKENDS__GEOMETRIC__URL` | `http://localhost:8003` | Geometric service URL |
| `GATEWAY__PIPELINE__SEARCH_K` | `5` | Number of candidates |
| `GATEWAY__PIPELINE__SIMILARITY_THRESHOLD` | `0.7` | Minimum similarity |
| `GATEWAY__PIPELINE__GEOMETRIC_VERIFICATION` | `true` | Enable verification |

### Port Assignments

| Service | Default Port | Environment Variable |
|---------|--------------|---------------------|
| Gateway | 8000 | `GATEWAY__SERVER__PORT` |
| Embeddings | 8001 | `EMBEDDINGS__SERVER__PORT` |
| Search | 8002 | `SEARCH__SERVER__PORT` |
| Geometric | 8003 | `GEOMETRIC__SERVER__PORT` |
| Storage | 8004 | `STORAGE__SERVER__PORT` |

---

## Performance Summary

| Operation | Typical Latency | P99 Latency |
|-----------|-----------------|-------------|
| Full identification (with geometric) | 150-300ms | 600ms |
| Full identification (no geometric) | 50-120ms | 250ms |
| Embedding extraction | 50-100ms | 200ms |
| Vector search (20 items) | <1ms | 5ms |
| Geometric verification (5 candidates) | 100-200ms | 400ms |
| Index building (20 objects) | 2-3s | 5s |

---

## Quick Start

```bash
# 1. Start all services
just up

# 2. Build the index
just build-index

# 3. Test identification
curl -X POST http://localhost:8000/identify \
  -H "Content-Type: application/json" \
  -d "{\"image\": \"$(base64 -i visitor_photo.jpg | tr -d '\n')\"}"

# 4. Check system health
curl http://localhost:8000/health
```
