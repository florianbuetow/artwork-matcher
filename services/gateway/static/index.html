<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artwork Matcher</title>
  <link rel="icon" href="data:,">
  <link rel="apple-touch-icon" href="data:,">
  <link rel="apple-touch-icon-precomposed" href="data:,">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Georgia", "Times New Roman", serif;
      background: #faf8f5;
      color: #2c2420;
      min-height: 100vh;
    }

    header {
      text-align: center;
      padding: 2.5rem 1rem 1.5rem;
      border-bottom: 1px solid #e0d8cf;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 400;
      letter-spacing: 0.04em;
      color: #3a3330;
    }

    header p {
      margin-top: 0.4rem;
      font-size: 0.9rem;
      color: #8a7e74;
      font-style: italic;
    }

    main {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* --- Drop Zone --- */

    .drop-zone {
      border: 2px dashed #c4b8aa;
      border-radius: 8px;
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: #8b6f47;
      background: #f5f0ea;
    }

    .drop-zone-label {
      font-size: 1rem;
      color: #6b5e52;
    }

    .drop-zone-hint {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #a89e94;
    }

    .drop-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* --- Preview --- */

    .preview {
      margin-top: 1.5rem;
      text-align: center;
      display: none;
    }

    .preview img {
      max-height: 300px;
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid #ddd5cc;
    }

    .preview-name {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #8a7e74;
    }

    /* --- Loading --- */

    .loading {
      margin-top: 2rem;
      text-align: center;
      display: none;
    }

    .spinner {
      width: 28px;
      height: 28px;
      border: 3px solid #e0d8cf;
      border-top-color: #8b6f47;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading p {
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: #8a7e74;
    }

    /* --- Results --- */

    .result {
      margin-top: 2rem;
      display: none;
    }

    .result h2 {
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 1rem;
      color: #3a3330;
    }

    .match-card {
      display: flex;
      gap: 1.25rem;
      padding: 1.25rem;
      background: #fff;
      border: 1px solid #e0d8cf;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .match-card img {
      width: 160px;
      height: 160px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ece6de;
      flex-shrink: 0;
    }

    .match-info {
      flex: 1;
      min-width: 0;
    }

    .match-info h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .match-info .artist {
      font-style: italic;
      color: #6b5e52;
      font-size: 0.9rem;
    }

    .match-info .year {
      font-size: 0.85rem;
      color: #8a7e74;
      margin-bottom: 0.75rem;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.35rem 1rem;
      font-size: 0.8rem;
    }

    .meta-grid dt { color: #8a7e74; }
    .meta-grid dd { color: #3a3330; font-weight: 500; }

    .no-match {
      padding: 1.5rem;
      background: #fff;
      border: 1px solid #e0d8cf;
      border-radius: 8px;
      text-align: center;
      color: #6b5e52;
    }

    .timing-bar {
      margin-top: 1rem;
      font-size: 0.75rem;
      color: #a89e94;
      text-align: right;
    }

    /* --- Error --- */

    .error {
      margin-top: 2rem;
      padding: 1rem 1.25rem;
      background: #fdf0ed;
      border: 1px solid #e8c4bb;
      border-radius: 8px;
      color: #7a3328;
      font-size: 0.9rem;
      display: none;
    }

    /* --- Alternatives toggle --- */

    .alternatives-section {
      margin-top: 0.5rem;
    }

    .alternatives-toggle {
      background: none;
      border: none;
      color: #8b6f47;
      font-size: 0.85rem;
      cursor: pointer;
      font-family: inherit;
      padding: 0.25rem 0;
    }

    .alternatives-toggle:hover {
      text-decoration: underline;
    }

    .alternatives-list {
      display: none;
      margin-top: 0.75rem;
    }

    .alternatives-list .match-card {
      opacity: 0.85;
    }

    .alternatives-list .match-card img {
      width: 100px;
      height: 100px;
    }
  </style>
</head>
<body>

<header>
  <h1>Artwork Matcher</h1>
  <p>Upload a visitor photo to identify the artwork</p>
</header>

<main>
  <div class="drop-zone" id="dropZone">
    <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp">
    <p class="drop-zone-label">Drop a photo here or click to browse</p>
    <p class="drop-zone-hint">Supports JPEG, PNG, and WebP</p>
  </div>

  <div class="preview" id="preview">
    <img id="previewImage" alt="Uploaded photo">
    <p class="preview-name" id="previewName"></p>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Identifying artwork…</p>
  </div>

  <div class="error" id="error"></div>

  <div class="result" id="result"></div>
</main>

<script>
  const GATEWAY_URL = window.location.origin;

  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");
  const preview = document.getElementById("preview");
  const previewImage = document.getElementById("previewImage");
  const previewName = document.getElementById("previewName");
  const loading = document.getElementById("loading");
  const error = document.getElementById("error");
  const result = document.getElementById("result");

  /* ---- Drag & Drop ---- */

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("drag-over");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("drag-over");
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag-over");
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (file) handleFile(file);
  });

  /* ---- Core Flow ---- */

  function handleFile(file) {
    if (!file.type.startsWith("image/")) {
      showError("Please select an image file.");
      return;
    }

    showPreview(file);
    identifyArtwork(file);
  }

  function showPreview(file) {
    const url = URL.createObjectURL(file);
    previewImage.src = url;
    previewName.textContent = file.name;
    preview.style.display = "block";
  }

  async function identifyArtwork(file) {
    hide(error);
    hide(result);
    show(loading);

    try {
      const base64 = await fileToBase64(file);

      const response = await fetch(`${GATEWAY_URL}/identify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          image: base64,
          options: {
            include_alternatives: true,
          },
        }),
      });

      if (!response.ok) {
        const body = await response.json().catch(() => null);
        throw new Error(body?.message || `Server error (${response.status})`);
      }

      const data = await response.json();
      renderResult(data);
    } catch (err) {
      showError(err.message);
    } finally {
      hide(loading);
    }
  }

  /* ---- Rendering ---- */

  function renderResult(data) {
    result.innerHTML = "";

    if (!data.match) {
      result.innerHTML = `
        <div class="no-match">
          <p>No matching artwork found.</p>
          ${data.debug?.highest_similarity != null
            ? `<p style="margin-top:0.4rem;font-size:0.8rem;color:#a89e94">
                Highest similarity: ${formatPercent(data.debug.highest_similarity)}
                (threshold: ${formatPercent(data.debug.threshold)})
               </p>`
            : ""}
        </div>
        ${renderTiming(data.timing)}
      `;
      show(result);
      return;
    }

    const matchHtml = renderMatchCard(data.match);
    const alternativesHtml = renderAlternatives(data.alternatives);
    const timingHtml = renderTiming(data.timing);

    result.innerHTML = `
      <h2>Match Found</h2>
      ${matchHtml}
      ${alternativesHtml}
      ${timingHtml}
    `;

    show(result);
  }

  function renderMatchCard(match) {
    const imageUrl = `${GATEWAY_URL}/objects/${match.object_id}/image`;
    const name = match.name || match.object_id;
    const artist = match.artist || "Unknown artist";
    const year = match.year || "";

    return `
      <div class="match-card">
        <img src="${imageUrl}" alt="${name}">
        <div class="match-info">
          <h3>${name}</h3>
          <p class="artist">${artist}</p>
          ${year ? `<p class="year">${year}</p>` : ""}
          <dl class="meta-grid">
            <dt>Confidence</dt>
            <dd>${formatPercent(match.confidence)}</dd>
            <dt>Similarity</dt>
            <dd>${formatPercent(match.similarity_score)}</dd>
            ${match.geometric_score != null ? `
              <dt>Geometric</dt>
              <dd>${formatPercent(match.geometric_score)}</dd>
            ` : ""}
            <dt>Method</dt>
            <dd>${match.verification_method}</dd>
          </dl>
        </div>
      </div>
    `;
  }

  function renderAlternatives(alternatives) {
    if (!alternatives || alternatives.length === 0) return "";

    const cards = alternatives.map(renderMatchCard).join("");

    return `
      <div class="alternatives-section">
        <button class="alternatives-toggle" onclick="toggleAlternatives(this)">
          Show ${alternatives.length} alternative${alternatives.length > 1 ? "s" : ""}
        </button>
        <div class="alternatives-list">
          ${cards}
        </div>
      </div>
    `;
  }

  function renderTiming(timing) {
    if (!timing) return "";

    const parts = [];
    if (timing.embedding_ms != null) parts.push(`embed ${timing.embedding_ms.toFixed(0)}ms`);
    if (timing.search_ms != null) parts.push(`search ${timing.search_ms.toFixed(0)}ms`);
    if (timing.geometric_ms != null && timing.geometric_ms > 0) {
      parts.push(`geometric ${timing.geometric_ms.toFixed(0)}ms`);
    }
    if (timing.total_ms != null) parts.push(`total ${timing.total_ms.toFixed(0)}ms`);

    return `<p class="timing-bar">${parts.join(" · ")}</p>`;
  }

  /* ---- Alternatives toggle ---- */

  function toggleAlternatives(button) {
    const list = button.nextElementSibling;
    const visible = list.style.display === "block";
    list.style.display = visible ? "none" : "block";
    const count = list.querySelectorAll(".match-card").length;
    button.textContent = visible
      ? `Show ${count} alternative${count > 1 ? "s" : ""}`
      : `Hide alternative${count > 1 ? "s" : ""}`;
  }

  /* ---- Helpers ---- */

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const base64 = dataUrl.split(",")[1];
        resolve(base64);
      };
      reader.onerror = () => reject(new Error("Failed to read file."));
      reader.readAsDataURL(file);
    });
  }

  function formatPercent(value) {
    return (value * 100).toFixed(1) + "%";
  }

  function showError(message) {
    error.textContent = message;
    show(error);
  }

  function show(el) { el.style.display = "block"; }
  function hide(el) { el.style.display = "none"; }
</script>

</body>
</html>
