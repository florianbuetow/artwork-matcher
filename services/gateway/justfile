# Default recipe: show available commands
_default:
    @just --list

# === Service Configuration ===
SERVICE_NAME := "gateway"
PORT := "8000"

# Show help information
help:
    @echo ""
    @clear
    @echo ""
    @printf "\033[0;34m=== Gateway Service ===\033[0m\n"
    @echo ""
    @echo "Available commands:"
    @just --list
    @echo ""

# === Environment Management ===

# Initialize the development environment
init:
    @echo ""
    @printf "\033[0;34m=== Initializing Development Environment ===\033[0m\n"
    @mkdir -p reports/coverage
    @mkdir -p reports/security
    @mkdir -p reports/pyright
    @mkdir -p reports/deptry
    @mkdir -p reports/performance
    @echo "Installing Python dependencies..."
    @uv sync --all-extras
    @printf "\033[0;32m✓ Development environment ready\033[0m\n"
    @echo ""

# Destroy the virtual environment
destroy:
    @echo ""
    @printf "\033[0;34m=== Destroying Virtual Environment ===\033[0m\n"
    @rm -rf .venv
    @rm -rf reports
    @printf "\033[0;32m✓ Virtual environment removed\033[0m\n"
    @echo ""

# === Run Service (Local) ===

# Run the service locally (no Docker) with hot reload
run:
    @echo ""
    @printf "\033[0;34m=== Running Gateway Service Locally on port 8000 ===\033[0m\n"
    @uv run uvicorn gateway.app:create_app --factory --reload --host 0.0.0.0 --port 8000

# Stop the locally running service
kill:
    #!/usr/bin/env bash
    printf "\n"
    printf "\033[0;34m=== Stopping Gateway Service (Local) ===\033[0m\n"
    printf "\n"

    # Find process listening on port 8000
    pid=$(lsof -ti :8000 2>/dev/null)

    if [ -n "$pid" ]; then
        printf "Service is running (PID: %s). Stopping...\n" "$pid"
        kill $pid 2>/dev/null
        sleep 1

        # Check if still running
        if lsof -ti :8000 > /dev/null 2>&1; then
            printf "\033[0;31m✗ Service still running. Forcing kill...\033[0m\n"
            kill -9 $(lsof -ti :8000) 2>/dev/null
            sleep 1
        fi

        if lsof -ti :8000 > /dev/null 2>&1; then
            printf "\033[0;31m✗ Failed to stop service\033[0m\n"
            exit 1
        else
            printf "\033[0;32m✓ Service stopped\033[0m\n"
        fi
    else
        printf "Service is not running\n"
    fi
    printf "\n"

# === Docker ===

# Run service in Docker (production mode, detached)
docker-up:
    @echo ""
    @printf "\033[0;34m=== Starting Gateway Service in Docker ===\033[0m\n"
    @cd ../.. && docker compose up -d gateway
    @echo ""
    @printf "\033[0;32m✓ Service running at http://localhost:8000\033[0m\n"
    @echo "  View logs: just docker-logs"
    @echo ""

# Run service in Docker (development mode with hot reload)
docker-up-dev:
    @echo ""
    @printf "\033[0;34m=== Starting Gateway Service in Docker (Dev Mode) ===\033[0m\n"
    @cd ../.. && docker compose -f docker-compose.yml -f docker-compose.dev.yml up gateway

# Stop service in Docker
docker-down:
    @echo ""
    @printf "\033[0;34m=== Stopping Gateway Service ===\033[0m\n"
    @cd ../.. && docker compose stop gateway
    @printf "\033[0;32m✓ Service stopped\033[0m\n"
    @echo ""

# View Docker logs for this service
docker-logs:
    @cd ../.. && docker compose logs -f gateway

# Build Docker image for this service
docker-build:
    @echo ""
    @printf "\033[0;34m=== Building Gateway Docker Image ===\033[0m\n"
    @cd ../.. && docker compose build gateway
    @printf "\033[0;32m✓ Image built\033[0m\n"
    @echo ""

# === Code Quality ===

# Check code style and formatting (read-only)
code-style:
    @echo ""
    @printf "\033[0;34m=== Checking Code Style ===\033[0m\n"
    @uv run ruff check .
    @echo ""
    @uv run ruff format --check .
    @echo ""
    @printf "\033[0;32m✓ Style checks passed\033[0m\n"
    @echo ""

# Auto-fix code style and formatting
code-format:
    @echo ""
    @printf "\033[0;34m=== Formatting Code ===\033[0m\n"
    @uv run ruff check . --fix
    @echo ""
    @uv run ruff format .
    @echo ""
    @printf "\033[0;32m✓ Code formatted\033[0m\n"
    @echo ""

# Run static type checking with mypy
code-typecheck:
    @echo ""
    @printf "\033[0;34m=== Running Type Checks ===\033[0m\n"
    @uv run mypy src/
    @echo ""
    @printf "\033[0;32m✓ Type checks passed\033[0m\n"
    @echo ""

# Run strict type checking with Pyright (LSP-based)
code-lspchecks:
    @echo ""
    @printf "\033[0;34m=== Running Pyright Type Checks ===\033[0m\n"
    @mkdir -p reports/pyright
    @uv run pyright --project pyrightconfig.json > reports/pyright/pyright.txt 2>&1 || true
    @uv run pyright --project pyrightconfig.json
    @echo ""
    @printf "\033[0;32m✓ Pyright checks passed\033[0m\n"
    @echo "  Report: reports/pyright/pyright.txt"
    @echo ""

# Run security checks with bandit
code-security:
    @echo ""
    @printf "\033[0;34m=== Running Security Checks ===\033[0m\n"
    @mkdir -p reports/security
    @uv run bandit -c pyproject.toml -r src -f txt -o reports/security/bandit.txt || true
    @uv run bandit -c pyproject.toml -r src
    @echo ""
    @printf "\033[0;32m✓ Security checks passed\033[0m\n"
    @echo ""

# Check dependency hygiene with deptry
code-deptry:
    @echo ""
    @printf "\033[0;34m=== Checking Dependencies ===\033[0m\n"
    @mkdir -p reports/deptry
    @uv run deptry src
    @echo ""
    @printf "\033[0;32m✓ Dependency checks passed\033[0m\n"
    @echo ""

# Generate code statistics with pygount
code-stats:
    @echo ""
    @printf "\033[0;34m=== Code Statistics ===\033[0m\n"
    @mkdir -p reports
    @uv run pygount src/ tests/ --suffix=py,md,txt,toml,yaml,yml --format=summary
    @echo ""
    @uv run pygount src/ tests/ --suffix=py,md,txt,toml,yaml,yml --format=summary > reports/code-stats.txt
    @printf "\033[0;32m✓ Report saved to reports/code-stats.txt\033[0m\n"
    @echo ""

# Check spelling in code and documentation
code-spell:
    @echo ""
    @printf "\033[0;34m=== Checking Spelling ===\033[0m\n"
    @uv run codespell src tests *.md *.toml --ignore-words=../../config/codespell/ignore.txt
    @echo ""
    @printf "\033[0;32m✓ Spelling checks passed\033[0m\n"
    @echo ""

# Scan dependencies for known vulnerabilities
code-audit:
    @echo ""
    @printf "\033[0;34m=== Scanning Dependencies for Vulnerabilities ===\033[0m\n"
    @uv run pip-audit
    @echo ""
    @printf "\033[0;32m✓ No known vulnerabilities found\033[0m\n"
    @echo ""

# Run Semgrep static analysis (uses root config)
code-semgrep:
    @echo ""
    @printf "\033[0;34m=== Running Semgrep Static Analysis ===\033[0m\n"
    @uv run semgrep --config ../../config/semgrep/ --error src
    @echo ""
    @printf "\033[0;32m✓ Semgrep checks passed\033[0m\n"
    @echo ""

# === Testing ===

# Run all tests (unit + integration in separate processes for isolation)
test:
    @echo ""
    @printf "\033[0;34m=== Running All Tests ===\033[0m\n"
    @just test-unit
    @just test-integration
    @printf "\033[0;32m✓ All tests passed\033[0m\n"
    @echo ""

# Run unit tests only (fast, isolated)
test-unit:
    @echo ""
    @printf "\033[0;34m=== Running Unit Tests ===\033[0m\n"
    @uv run pytest tests/unit -m unit -v
    @echo ""

# Run integration tests only
test-integration:
    @echo ""
    @printf "\033[0;34m=== Running Integration Tests ===\033[0m\n"
    @uv run pytest tests/integration -m integration -v
    @echo ""

# Run performance tests (slow)
test-performance:
    @echo ""
    @printf "\033[0;34m=== Running Performance Tests ===\033[0m\n"
    @uv run pytest tests/performance -m performance -v -s
    @echo ""

# Run unit tests with coverage report and threshold check
test-coverage: init
    @echo ""
    @printf "\033[0;34m=== Running Unit Tests with Coverage ===\033[0m\n"
    @uv run pytest tests/ -v \
        --cov=src \
        --cov-report=html:reports/coverage/html \
        --cov-report=term \
        --cov-report=xml:reports/coverage/coverage.xml \
        --cov-fail-under=80
    @echo ""
    @printf "\033[0;32m✓ Coverage threshold met\033[0m\n"
    @echo "  HTML: reports/coverage/html/index.html"
    @echo ""

# === CI Pipelines ===

# Run ALL validation checks (verbose) - uses unit tests for speed
ci:
    #!/usr/bin/env bash
    set -e
    printf "\n"
    printf "\033[0;34m=== Running CI Checks for Gateway Service ===\033[0m\n"
    printf "\n"
    just init
    just code-format
    just code-style
    just code-typecheck
    just code-security
    just code-deptry
    just code-spell
    just code-semgrep
    just code-audit
    just test-unit
    just code-lspchecks
    printf "\n"
    printf "\033[0;32m✓ All CI checks passed\033[0m\n"
    printf "\n"

# Run ALL validation checks silently (only show output on errors) - uses unit tests for speed
ci-quiet:
    #!/usr/bin/env bash
    set -e
    printf "\033[0;34m=== Running CI Checks (Quiet Mode) ===\033[0m\n"
    TMPFILE=$(mktemp)
    trap "rm -f $TMPFILE" EXIT

    just init > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Init failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Init passed\033[0m\n"

    just code-format > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-format failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-format passed\033[0m\n"

    just code-style > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-style failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-style passed\033[0m\n"

    just code-typecheck > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-typecheck failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-typecheck passed\033[0m\n"

    just code-security > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-security failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-security passed\033[0m\n"

    just code-deptry > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-deptry failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-deptry passed\033[0m\n"

    just code-spell > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-spell failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-spell passed\033[0m\n"

    just code-semgrep > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-semgrep failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-semgrep passed\033[0m\n"

    just code-audit > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-audit failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-audit passed\033[0m\n"

    just test-unit > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Unit tests failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Unit tests passed\033[0m\n"

    just code-lspchecks > $TMPFILE 2>&1 || { printf "\033[0;31m✗ Code-lspchecks failed\033[0m\n"; cat $TMPFILE; exit 1; }
    printf "\033[0;32m✓ Code-lspchecks passed\033[0m\n"

    printf "\n"
    printf "\033[0;32m✓ All CI checks passed\033[0m\n"
    printf "\n"

# Run full CI including integration tests (slower, tests against mocked backends)
ci-all:
    #!/usr/bin/env bash
    set -e
    printf "\n"
    printf "\033[0;34m=== Running All CI Checks (with Integration Tests) ===\033[0m\n"
    printf "\n"
    just ci
    just test-integration
    printf "\n"
    printf "\033[0;32m✓ All CI checks (including integration tests) passed\033[0m\n"
    printf "\n"

# Check service health status
status:
    #!/usr/bin/env bash
    printf "\n=== Gateway Service Status ===\n\n"

    health=$(curl -s http://localhost:8000/health 2>/dev/null)
    if [ $? -eq 0 ] && [ -n "$health" ]; then
        status=$(echo "$health" | jq -r '.status' 2>/dev/null || echo "unknown")
        printf "✓ Gateway (port 8000) - %s\n" "$status"

        info=$(curl -s http://localhost:8000/info 2>/dev/null)
        if [ -n "$info" ]; then
            version=$(echo "$info" | jq -r '.version' 2>/dev/null || echo "unknown")
            printf "  Version: %s\n" "$version"

            # Show backend statuses
            embeddings=$(echo "$health" | jq -r '.backends.embeddings // "unknown"' 2>/dev/null)
            search=$(echo "$health" | jq -r '.backends.search // "unknown"' 2>/dev/null)
            geometric=$(echo "$health" | jq -r '.backends.geometric // "unknown"' 2>/dev/null)
            printf "  Backends: embeddings=%s, search=%s, geometric=%s\n" "$embeddings" "$search" "$geometric"
        fi
    else
        printf "✗ Gateway (port 8000) - not responding\n"
    fi
    printf "\n"
